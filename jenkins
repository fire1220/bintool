#!/bin/bash

configInit=$(cat <<!
# username=xxxx
# appToken=xxxx
# url=https://test-jenkins.xxxx.com
# 目录和pod name的对应关系
# podNameList=(
#     wm-light-backend=k8s-test-php-backend-new
#     wm-light-frontend=k8s-test-php-frontend-new
# )
# 目录和发布参数的对应关系
# paramList=(
#     wm-backend=backend_version
#     wm-backend=title
#     wm-frontend=frontend_version
# )
!
)

configPath="$HOME/.config/jenkins/.jenkinsrc"

declare -r dirName="$(basename "$(pwd)")"

function helpInit(){
    cat <<!
        command [-c] commitId

        第一次执行会自动生产一个配置文件:
            1.配置文件路径："$configPath"
            2.编辑该配置文件后就可以使用了

        参数：
            -c commitId(默认选项)

!
    exit 0
}


if [ ! -f "$configPath" ];then
    if [ ! -d "$(dirname "$configPath")" ];then
        mkdir -p "$(dirname "$configPath")"
    fi
    echo "$configInit" > "$configPath"
fi

. "$configPath"

function main(){
    local commitId=""
    OPTIND=1
    while getopts ':c:h' opt;do
        case "$opt" in
            c)
                commitId="$OPTARG";;
            h)
                helpInit
                ;;
        esac
    done
    shift $(($OPTIND-1))

    if [[ "$username" == "" ]] || [[ "$appToken" == "" ]] || [[ "$url" == ""  ]] || [[ "$podNameList" == "" ]] || [[ "$paramList" == "" ]];then
        echo "请先编辑配置文件：$configPath"
        exit 0
    fi


    if [[ "$commitId" == "" ]];then
        commitId="$1"
    fi

    if [[ "$commitId" == "" ]];then
        echo >&2 "commitId 不能为空"
        exit 1
    fi
    local params=""
    for v in "${paramList[@]}";do
        local name="${v%%=*}"
        local paramKey="${v#*=}"
        if [[ "$name" != "$dirName" ]];then
            continue
        fi
        params="${params} --form '${paramKey}=\"${commitId}\"'"
    done

    local podList=()
    local podListIndex=()
    local execStr=""
    for v in "${podNameList[@]}";do
        local name="${v%%=*}"
        local podName="${v#*=}"
        if [[ "$name" != "$dirName" ]];then
            continue
        fi
        execStr="curl -X POST -u ${username}:${appToken} ${url}/job/${podName}/buildWithParameters ${params}"
        echo "$execStr"
        eval "$execStr"
        podList[$podListIndex]="${podName}"
        podListIndex=$(($podListIndex+1))
    done
    if [[ "$execStr" == "" ]];then
        echo "没有匹配到要构建的指令"
        exit 0
    fi

    progressPod "$podList"

    exit 0
}

function progressPod() {
    local podList="$1"
    if [[ "$podList" == "" ]];then
        return 0
    fi
    local progressPodList=()
    local progressIndex=0
    for v in "$podList";do
        execStr="curl -s -X POST -u ${username}:${appToken} '${url}/job/${v}/lastBuild/api/json?pretty=true' | jq '.number'"
        echo "$execStr"
        local buildNumber="$(eval "$execStr")"
        progressPodList[$progressIndex]="${v}/${buildNumber}"
        progressIndex=$(($progressIndex+1))
    done
    if [[ "$progressPodList" != "" ]];then
        local isExit=true
        for v in {1..500};do
            local strTemp=""
            for v2 in "$progressPodList";do
                execStr="curl -s -X POST -u ${username}:${appToken} '${url}/job/${v2}/api/json?pretty=true'"
                temp="$(eval "$execStr")"
                local building="$(echo "$temp" | jq '.building')"
                local duration="$(echo "$temp" | jq '.duration')"
                local estimatedDuration="$(echo "$temp" | jq '.estimatedDuration')"
                local result="$(echo "$temp" | jq -r '.result')"

                local proportionNum="$((100*$duration/$estimatedDuration))"
                if (($proportionNum > 100)) ;then
                    proportionNum=99
                fi
                if [[ "$result" == "SUCCESS" ]];then
                    proportionNum=100
                fi
                resultTemp="$result"
                if [[ "$resultTemp" == "null" ]];then
                    resultTemp="ing..."
                fi
                strTemp="${strTemp} [${v2}]:【${proportionNum}%%】【${resultTemp}】"
                if [[ "$result" == "null" ]];then
                    isExit=false
                fi
            done
            printf "\r${strTemp}"
            if $isExit ;then
                break
            fi
            sleep 2
        done
        echo ""
    fi
    return 0
}

    # podList=("k8s-test-php-wm-light-backend-new")
    # progressPod "$podList"

main $@
